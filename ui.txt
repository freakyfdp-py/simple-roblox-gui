--[[
    ModularMenu.lua - A complete, feature-rich Roblox UI module.
    Features:
    - Custom, modern styling.
    - Dragging and Movement using the title bar.
    - Resizing via a bottom-right handle.
    - Tab and Checkbox control creation.
    - Toast notifications.
    - Blur effect toggle.
    
    FIX: Removed automatic canvas update from createCheckbox to prevent layout timing issues.
    The user script must now call finalizeTab() after creating all controls for a tab.
]]

local player = game.Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ContextActionService = game:GetService("ContextActionService")

-- Configuration Constants
local CONTROL_HEIGHT = 40
local CONTROL_WIDTH = 330
local TAB_HEIGHT = 35
local MIN_WIDTH = 350 -- Updated for better look
local MIN_HEIGHT = 200
local RESIZE_HANDLE_SIZE = 15

-- Color Palette (Dark Theme with Blue Accent)
local LABEL_COLOR = Color3.fromRGB(220,220,255)
local BACKGROUND_COLOR = Color3.fromRGB(30,30,45)
local ACCENT_COLOR = Color3.fromRGB(80,140,255)
local SUCCESS_COLOR = Color3.fromRGB(34,197,94)
local OFF_COLOR = Color3.fromRGB(60,60,80)
local TITLE_COLOR = Color3.fromRGB(45,45,65)
local TAB_INACTIVE_COLOR = Color3.fromRGB(55,55,75)
local TAB_ACTIVE_COLOR = ACCENT_COLOR

-- Internal State Variables
local controlStates = {}
local tabs = {}
local currentTab = nil
local blur = Instance.new("BlurEffect")
local isMinimized = false
local gui, outer, titleBar, contentArea, tabsFrame, closeButton, minimizeButton

-- Drag and Resize State
local isDragging = false
local isResizing = false
local dragStartPos = Vector2.new()
local frameStartPos = UDim2.new()
local frameStartSize = UDim2.new()
local resizeEdge = "" -- "BR" for bottom-right

-- Utility Functions

local function createToastNotification(message, duration, color)
    duration = duration or 3
    color = color or ACCENT_COLOR
    local toast = Instance.new("Frame")
    toast.Size = UDim2.fromOffset(300, 50)
    -- Position slightly above the bottom center
    toast.Position = UDim2.new(0.5, -150, 1, 10)
    toast.BackgroundColor3 = color
    toast.BorderSizePixel = 0
    toast.ZIndex = 10
    toast.Parent = PlayerGui
    
    local toastCorner = Instance.new("UICorner")
    toastCorner.CornerRadius = UDim.new(0, 8)
    toastCorner.Parent = toast
    
    local toastLabel = Instance.new("TextLabel")
    toastLabel.Size = UDim2.new(1, -20, 1, -10)
    toastLabel.Position = UDim2.new(0, 10, 0, 5)
    toastLabel.BackgroundTransparency = 1
    toastLabel.Text = message
    toastLabel.TextColor3 = Color3.new(1, 1, 1)
    toastLabel.Font = Enum.Font.SourceSans
    toastLabel.TextSize = 18
    toastLabel.TextWrapped = true
    toastLabel.TextYAlignment = Enum.TextYAlignment.Center
    toastLabel.Parent = toast
    
    local infoShow = TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    local infoHide = TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.In)
    
    -- Show animation (move up)
    TweenService:Create(toast, infoShow, {Position = UDim2.new(0.5, -150, 1, -60)}):Play()
    
    task.wait(duration)
    
    -- Hide animation (move down and fade)
    local tweenHide = TweenService:Create(toast, infoHide, {Position = UDim2.new(0.5, -150, 1, 10), BackgroundTransparency = 0})
    tweenHide:Play()
    tweenHide.Completed:Wait()
    
    toast:Destroy()
end

-- Renamed to finalizeTab, but keeping the internal name for consistency within the module
local function updateCanvasSize(content) 
    -- This ensures the scrolling frame content fits the controls
    local listLayout = content:FindFirstChildOfClass("UIListLayout")
    if listLayout then
        -- Wait one frame to allow the UIListLayout to process all new children and update AbsoluteContentSize
        RunService.Heartbeat:Wait()
        
        -- Calculate total height needed for children and padding
        local totalHeight = listLayout.AbsoluteContentSize.Y
        -- Calculate visible height of the ScrollingFrame
        local visibleHeight = content.AbsoluteSize.Y
        -- Set canvas size, ensuring it's at least as tall as the visible area
        content.CanvasSize = UDim2.new(0, 0, 0, math.max(totalHeight + 20, visibleHeight))
    end
end

-- UI Control Creators

local function createTab(name)
    -- Ensure all existing tabs are inactive
    for _, t in pairs(tabs) do
        t.Button.BackgroundColor3 = TAB_INACTIVE_COLOR
        t.Content.Visible = false
    end

    -- Create Button
    local tabButton = Instance.new("TextButton")
    -- Adjust size to be responsive to the tabs frame size, dividing space by number of tabs
    tabButton.Size = UDim2.new(1 / (table.getn(tabs) + 1), 0, 1, 0)
    tabButton.Text = name
    tabButton.BackgroundColor3 = TAB_ACTIVE_COLOR
    tabButton.TextColor3 = Color3.new(1, 1, 1)
    tabButton.Font = Enum.Font.SourceSansBold
    tabButton.TextSize = 16
    tabButton.BorderSizePixel = 0
    tabButton.Parent = tabsFrame
    
    local tabCorner = Instance.new("UICorner")
    tabCorner.CornerRadius = UDim.new(0, 5)
    tabCorner.Parent = tabButton

    -- Re-size existing tab buttons to fit the new tab
    local tabCount = table.getn(tabs) + 1
    local newSize = UDim2.new(1 / tabCount, 0, 1, 0)
    for _, t in pairs(tabs) do
        t.Button.Size = newSize
    end
    tabButton.Size = newSize

    -- Create Content Scrolling Frame
    local content = Instance.new("ScrollingFrame")
    content.Size = UDim2.new(1, 0, 1, 0)
    content.Position = UDim2.new(0, 0, 0, 0)
    content.BackgroundTransparency = 1
    content.CanvasSize = UDim2.new(0, 0, 0, 0) -- Set dynamically later
    content.Visible = true
    content.ScrollBarThickness = 6
    content.Parent = contentArea
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 15)
    listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    listLayout.Parent = content
    
    -- Tab Activation Logic
    tabButton.MouseButton1Click:Connect(function()
        for _, t in pairs(tabs) do
            t.Button.BackgroundColor3 = TAB_INACTIVE_COLOR
            t.Content.Visible = false
        end
        
        tabButton.BackgroundColor3 = TAB_ACTIVE_COLOR
        content.Visible = true
        currentTab = {Button = tabButton, Content = content}
        updateCanvasSize(content) -- Recalculate size when switching tabs
    end)
    
    tabs[name] = {Button = tabButton, Content = content}
    currentTab = {Button = tabButton, Content = content} -- Set as active tab
    
    return content
end

local function createCheckbox(parent, labelText, initial)
    local c = Instance.new("Frame")
    c.Size = UDim2.fromOffset(CONTROL_WIDTH, CONTROL_HEIGHT)
    c.BackgroundTransparency = 1
    c.Parent = parent
    
    local padding = Instance.new("UIPadding")
    padding.PaddingLeft = UDim.new(0, 10)
    padding.PaddingRight = UDim.new(0, 10)
    padding.Parent = c

    -- Label
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -50, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextColor3 = LABEL_COLOR
    label.Font = Enum.Font.SourceSans
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = c

    -- Checkbox Button
    local box = Instance.new("TextButton")
    box.Size = UDim2.fromOffset(30, 30)
    box.Position = UDim2.new(1, -40, 0.5, -15) -- Centered vertically, offset from right
    box.Text = ""
    box.BorderSizePixel = 0
    box.Parent = c
    
    local cc = Instance.new("UICorner")
    cc.CornerRadius = UDim.new(0, 5)
    cc.Parent = box
    
    local state = initial or false
    
    local function update()
        if state then
            box.BackgroundColor3 = SUCCESS_COLOR
            box.Text = "âœ“"
            box.TextSize = 25
            box.TextColor3 = Color3.new(1, 1, 1)
        else
            box.BackgroundColor3 = OFF_COLOR
            box.Text = ""
        end
        controlStates[labelText].State = state
    end
    
    box.MouseButton1Click:Connect(function()
        state = not state
        update()
    end)
    
    controlStates[labelText] = {Type = "Checkbox", State = state, Instance = box, Toggle = function(newState)
        if newState ~= nil and typeof(newState) == "boolean" then
            state = newState
        else
            state = not state
        end
        update()
    end}
    
    update() -- Initial update to set colors
    -- updateCanvasSize(parent) -- Removed: Now handled by the calling script via finalizeTab
    return c
end

-- Core UI Logic (Drag, Resize, Minimize)

local function startDrag(input)
    isDragging = true
    dragStartPos = input.Position
    frameStartPos = outer.Position
    -- Prevent controls from interacting while dragging
    ContextActionService:BindAction("Drag", function() return Enum.ContextActionResult.Sink end, false, Enum.UserInputType.MouseMovement)
end

local function endDrag()
    isDragging = false
    ContextActionService:UnbindAction("Drag")
end

local function startResize(input)
    isResizing = true
    dragStartPos = input.Position
    frameStartSize = outer.Size
    -- Prevent controls from interacting while resizing
    ContextActionService:BindAction("Resize", function() return Enum.ContextActionResult.Sink end, false, Enum.UserInputType.MouseMovement)
end

local function endResize()
    isResizing = false
    ContextActionService:UnbindAction("Resize")
end

local function onInputChanged(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and isDragging then
        local delta = input.Position - dragStartPos
        local newX = frameStartPos.X.Offset + delta.X
        local newY = frameStartPos.Y.Offset + delta.Y
        
        -- Clamp to screen bounds (optional but good practice)
        local maxX = PlayerGui.AbsoluteSize.X - outer.AbsoluteSize.X
        local maxY = PlayerGui.AbsoluteSize.Y - outer.AbsoluteSize.Y
        
        newX = math.clamp(newX, 0, maxX)
        newY = math.clamp(newY, 0, maxY)
        
        outer.Position = UDim2.fromOffset(newX, newY)
        
    elseif input.UserInputType == Enum.UserInputType.MouseMovement and isResizing then
        local delta = input.Position - dragStartPos
        local newWidth = frameStartSize.X.Offset + delta.X
        local newHeight = frameStartSize.Y.Offset + delta.Y
        
        -- Clamp to minimum size
        newWidth = math.max(newWidth, MIN_WIDTH)
        newHeight = math.max(newHeight, MIN_HEIGHT)

        outer.Size = UDim2.fromOffset(newWidth, newHeight)
    end
end

local function toggleMinimize()
    isMinimized = not isMinimized
    local targetSize
    
    if isMinimized then
        -- Minimize to just the title bar height
        targetSize = UDim2.fromOffset(outer.AbsoluteSize.X, titleBar.AbsoluteSize.Y)
        -- Hide everything else
        tabsFrame.Visible = false
        contentArea.Visible = false
        minimizeButton.Text = "[]" -- Maximize icon (or square icon)
        
    else
        -- Restore to original size
        targetSize = UDim2.fromOffset(frameStartSize.X.Offset, frameStartSize.Y.Offset)
        -- Show everything
        tabsFrame.Visible = true
        contentArea.Visible = true
        minimizeButton.Text = "_" -- Minimize icon (or dash icon)
    end
    
    local info = TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    TweenService:Create(outer, info, {Size = targetSize}):Play()
end

local function toggleBlur(enabled)
    if enabled then
        if not blur.Parent then
            blur.Parent = game.Lighting
            blur.Size = 0
            TweenService:Create(blur, TweenInfo.new(0.5), {Size = 15}):Play()
        end
    else
        if blur.Parent then
            TweenService:Create(blur, TweenInfo.new(0.5), {Size = 0}):Play()
            task.wait(0.5)
            blur.Parent = nil
        end
    end
end

-- Initialization Function

local function initializeGUI()
    gui = Instance.new("ScreenGui")
    gui.Name = "ModularMenu"
    gui.Parent = PlayerGui
    gui.ResetOnSpawn = false -- Crucial for persistent UIs

    -- Outer Frame (The Window)
    outer = Instance.new("Frame")
    outer.Size = UDim2.fromOffset(350, 600)
    outer.Position = UDim2.new(0.5, -175, 0.5, -300)
    outer.BackgroundColor3 = BACKGROUND_COLOR
    outer.BorderSizePixel = 0
    outer.ZIndex = 1
    outer.Parent = gui
    frameStartSize = outer.Size -- Save initial size
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = outer

    -- Title Bar (Drag Handle)
    titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = TITLE_COLOR
    titleBar.Parent = outer
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -70, 1, 0) -- Make space for buttons
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "ðŸŒŸ Exploit Controls Pro"
    titleLabel.TextColor3 = LABEL_COLOR
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 20
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.Parent = titleBar

    -- Control Buttons (Close, Minimize, Blur)
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Size = UDim2.new(0, 65, 1, 0)
    buttonFrame.Position = UDim2.new(1, -70, 0, 0)
    buttonFrame.BackgroundTransparency = 1
    buttonFrame.Parent = titleBar
    
    local btnList = Instance.new("UIListLayout")
    btnList.FillDirection = Enum.FillDirection.Horizontal
    btnList.HorizontalAlignment = Enum.HorizontalAlignment.Right
    btnList.Padding = UDim.new(0, 5)
    btnList.Parent = buttonFrame
    
    -- Blur Toggle Button
    local blurButton = Instance.new("TextButton")
    blurButton.Size = UDim2.fromOffset(25, 25)
    blurButton.BackgroundColor3 = OFF_COLOR
    blurButton.Text = "B" -- Blur
    blurButton.TextColor3 = Color3.new(1,1,1)
    blurButton.Font = Enum.Font.SourceSansBold
    blurButton.TextSize = 18
    blurButton.Parent = buttonFrame
    
    local blurCorner = Instance.new("UICorner")
    blurCorner.CornerRadius = UDim.new(0, 4)
    blurCorner.Parent = blurButton

    local isBlurred = false
    blurButton.MouseButton1Click:Connect(function()
        isBlurred = not isBlurred
        toggleBlur(isBlurred)
        blurButton.BackgroundColor3 = isBlurred and ACCENT_COLOR or OFF_COLOR
    end)

    -- Minimize Button
    minimizeButton = Instance.new("TextButton")
    minimizeButton.Size = UDim2.fromOffset(25, 25)
    minimizeButton.BackgroundColor3 = OFF_COLOR
    minimizeButton.Text = "_" -- Minimize icon
    minimizeButton.TextColor3 = Color3.new(1,1,1)
    minimizeButton.Font = Enum.Font.SourceSansBold
    minimizeButton.TextSize = 22
    minimizeButton.Parent = buttonFrame
    
    local minCorner = Instance.new("UICorner")
    minCorner.CornerRadius = UDim.new(0, 4)
    minCorner.Parent = minimizeButton
    
    minimizeButton.MouseButton1Click:Connect(toggleMinimize)

    -- Close Button
    closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.fromOffset(25, 25)
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.new(1,1,1)
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.TextSize = 18
    closeButton.Parent = buttonFrame
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 4)
    closeCorner.Parent = closeButton

    closeButton.MouseButton1Click:Connect(function()
        toggleBlur(false)
        gui:Destroy()
    end)
    
    -- Tabs Frame
    tabsFrame = Instance.new("Frame")
    tabsFrame.Size = UDim2.new(1, -20, 0, TAB_HEIGHT)
    tabsFrame.Position = UDim2.new(0, 10, 0, 40)
    tabsFrame.BackgroundTransparency = 1
    tabsFrame.Parent = outer
    
    local tll = Instance.new("UIListLayout")
    tll.FillDirection = Enum.FillDirection.Horizontal
    tll.Padding = UDim.new(0, 5)
    tll.HorizontalAlignment = Enum.HorizontalAlignment.Left
    tll.Parent = tabsFrame

    -- Content Area
    contentArea = Instance.new("Frame")
    contentArea.Size = UDim2.new(1, -20, 1, -(40 + TAB_HEIGHT + 20)) -- 40 (title) + 35 (tab) + 20 (padding)
    contentArea.Position = UDim2.new(0, 10, 0, 40 + TAB_HEIGHT + 10)
    contentArea.BackgroundTransparency = 1
    contentArea.ClipsDescendants = true
    contentArea.Parent = outer
    
    -- Resizing Handle
    local resizeHandle = Instance.new("Frame")
    resizeHandle.Size = UDim2.fromOffset(RESIZE_HANDLE_SIZE, RESIZE_HANDLE_SIZE)
    resizeHandle.Position = UDim2.new(1, -RESIZE_HANDLE_SIZE, 1, -RESIZE_HANDLE_SIZE)
    resizeHandle.BackgroundColor3 = ACCENT_COLOR
    resizeHandle.BackgroundTransparency = 0.5
    resizeHandle.BorderSizePixel = 0
    resizeHandle.Parent = outer
    resizeHandle.Cursor = Enum.Cursor.SizeNWSE -- Diagonal resize cursor
    
    local handleCorner = Instance.new("UICorner")
    handleCorner.CornerRadius = UDim.new(0, 5)
    handleCorner.Parent = resizeHandle

    -- Dragging and Resizing Connections
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            startDrag(input)
        end
    end)

    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            endDrag()
        end
    end)
    
    resizeHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            startResize(input)
        end
    end)

    resizeHandle.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            endResize()
            -- After resizing, re-calculate canvas size for the current tab
            if currentTab then
                updateCanvasSize(currentTab.Content)
            end
        end
    end)
    
    UserInputService.InputChanged:Connect(onInputChanged)
    
    -- Ensure content is updated when the frame is finished tweening after minimize/maximize
    outer:GetPropertyChangedSignal("Size"):Connect(function()
        if not isResizing and not isDragging and currentTab and not isMinimized then
             updateCanvasSize(currentTab.Content)
        end
    })

end

initializeGUI()

-- Public Interface for the Module
local ModularMenu = {
    createTab = createTab,
    createCheckbox = createCheckbox,
    createToastNotification = createToastNotification,
    getControlValue = function(n)
        local s = controlStates[n]
        return s and s.State or nil
    end,
    -- Allows external scripts to manually toggle a control
    setControlState = function(n, newState)
        local s = controlStates[n]
        if s and s.Toggle then
            s.Toggle(newState)
            return true
        end
        return false
    end,
    -- Provides access to the main frame for advanced manipulation
    Frame = outer,
    -- NEW: Function to manually force the canvas to size correctly
    finalizeTab = updateCanvasSize,
}

return ModularMenu
