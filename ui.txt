--[[
    Roblox UI Library - Complete Implementation (Library.lua)
    
    NEW ENHANCEMENTS:
    1. Increased Window size (THEME.WindowSize).
    2. Implemented Section Flow-Down Logic using UIGridLayout for multi-row sections.
    3. Added ZIndex and InputBlocker logic for Dropdowns to ensure they overlay and disable elements below them.
--]]

local Library = {}
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService") 

-- --- THEME & CONSTANTS ---
local THEME = {
    -- Colors
    Background = Color3.fromRGB(30, 30, 30),
    Accent = Color3.fromRGB(80, 150, 255),
    Header = Color3.fromRGB(40, 40, 40),
    Text = Color3.fromRGB(220, 220, 220),
    ControlBg = Color3.fromRGB(45, 45, 45),
    ControlHover = Color3.fromRGB(60, 60, 60),
    ToastBg = Color3.fromRGB(20, 20, 20),
    
    -- Sizes
    WindowSize = Vector2.new(650, 500), -- Increased Size!
    HeaderHeight = 30,
    TabButtonWidth = 80,
    Padding = 8,
    ControlHeight = 22,
    CornerRadius = UDim.new(0, 5),
    
    -- Layout
    SectionColumnCount = 2, -- New constant for grid layout
    SectionContentPadding = 8,
}

-- --- HELPER FUNCTIONS ---

-- Creates a base frame with common properties
local function CreateBaseFrame(parent, name, size, position, color, radius)
    local frame = Instance.new("Frame")
    frame.Name = name
    frame.Size = size
    frame.Position = position or UDim2.fromScale(0, 0)
    frame.BackgroundColor3 = color or THEME.Background
    frame.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = radius or THEME.CornerRadius
    corner.Parent = frame
    
    frame.Parent = parent
    return frame
end

-- Creates a base button with common properties
local function CreateButton(parent, text, size, position, color, radius)
    local button = Instance.new("TextButton")
    button.Name = text:gsub("%s", "")
    button.Text = text
    button.Size = size
    button.Position = position or UDim2.fromScale(0, 0)
    button.BackgroundColor3 = color or THEME.ControlBg
    button.TextColor3 = THEME.Text
    button.Font = Enum.Font.SourceSans
    button.TextSize = 14
    button.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = radius or THEME.CornerRadius
    corner.Parent = button

    local defaultColor = color or THEME.ControlBg

    -- Simple hover effect
    button.MouseEnter:Connect(function() button.BackgroundColor3 = THEME.ControlHover end)
    button.MouseLeave:Connect(function() button.BackgroundColor3 = defaultColor end)

    button.Parent = parent
    return button
end

-- --- 1. BASE COMPONENT CLASS (Internal) ---

local function BaseComponent(Parent, Options)
    local self = {}
    self.Options = Options or {}
    self.Children = {}
    self.Parent = Parent
    self.Instance = nil -- Stores the main Roblox Instance
    
    function self:AddChild(component)
        table.insert(self.Children, component)
        return component
    end
    
    return self
end

-- --- 2. WINDOW (The Entry Point) ---

function Library.init(Title)
    local Window = BaseComponent(Library, {Text = Title})
    
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "LibGUI"
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.Parent = PlayerGui

    -- Input Blocker for dropdowns (initially hidden)
    local InputBlocker = Instance.new("Frame")
    InputBlocker.Name = "InputBlocker"
    InputBlocker.Size = UDim2.fromScale(1, 1)
    InputBlocker.BackgroundTransparency = 1
    InputBlocker.ZIndex = 4 -- Just below the dropdown (5)
    InputBlocker.Active = true -- Key to blocking input
    InputBlocker.Visible = false
    InputBlocker.Parent = ScreenGui
    Window.InputBlocker = InputBlocker

    -- Main Window Frame
    local W = THEME.WindowSize
    local WindowFrame = CreateBaseFrame(
        ScreenGui, Title:gsub("%s", "") .. "Window",
        UDim2.new(0, W.X, 0, W.Y), 
        UDim2.new(0.5, -W.X/2, 0.5, -W.Y/2),
        THEME.Background
    )
    WindowFrame.Active = true -- Important for dragging
    Window.Instance = WindowFrame

    -- Header Bar (for dragging)
    local Header = CreateBaseFrame(WindowFrame, "Header", 
        UDim2.new(1, 0, 0, THEME.HeaderHeight), nil, THEME.Header)
    Header.Active = true
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Text = Title
    TitleLabel.Size = UDim2.new(1, -10, 1, 0)
    TitleLabel.Position = UDim2.new(0, 5, 0, 0)
    TitleLabel.TextColor3 = THEME.Text
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Font = Enum.Font.SourceSansBold
    TitleLabel.TextSize = 18
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Parent = Header

    -- Content Area
    local ContentFrame = CreateBaseFrame(WindowFrame, "Content",
        UDim2.new(1, 0, 1, -THEME.HeaderHeight), 
        UDim2.new(0, 0, 0, THEME.HeaderHeight),
        THEME.Background
    )
    Window.ContentFrame = ContentFrame
    
    -- Tab Bar Area
    local TabBar = CreateBaseFrame(ContentFrame, "TabBar",
        UDim2.new(0.15, 0, 1, 0), UDim2.fromScale(0, 0), THEME.Header)
    
    local TabListLayout = Instance.new("UIListLayout")
    TabListLayout.FillDirection = Enum.FillDirection.Vertical
    TabListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    TabListLayout.Padding = UDim.new(0, THEME.Padding)
    TabListLayout.Parent = TabBar

    -- Main Page Content Area
    local PageContainer = CreateBaseFrame(ContentFrame, "PageContainer",
        UDim2.new(0.85, 0, 1, 0), UDim2.fromScale(0.15, 0), THEME.Background)
    PageContainer.BackgroundTransparency = 1
    
    -- FIX: Use a vertical layout for the content wrapper (SectionContainer)
    local ContentLayout = Instance.new("UIListLayout")
    ContentLayout.FillDirection = Enum.FillDirection.Vertical
    ContentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    ContentLayout.Padding = UDim.new(0, THEME.Padding)
    ContentLayout.Parent = PageContainer

    Window.PageContainer = PageContainer
    
    -- Dragging Logic
    local Dragging = false
    local DragOffset = Vector2.zero
    
    Header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            Dragging = true
            DragOffset = input.Position - WindowFrame.AbsolutePosition
            Header.LayoutOrder = 1 -- Bring to front
        end
    end)
    
    Header.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            Dragging = false
        end
    end)
    
    RunService.RenderStepped:Connect(function()
        if Dragging then
            WindowFrame.Position = UDim2.fromOffset(
                Players.LocalPlayer:GetMouse().X - DragOffset.X,
                Players.LocalPlayer:GetMouse().Y - DragOffset.Y
            )
        end
    end)

    -- --- TAB METHOD ---
    
    Window.addTab = function(Name)
        local Tab = BaseComponent(Window, {Text = Name})
        Tab.Sections = {} -- Store sections for layout
        
        -- Tab Button
        local TabButton = CreateButton(TabBar, Name, 
            UDim2.new(1, 0, 0, 30), nil, THEME.Header)
        TabButton.TextXAlignment = Enum.TextXAlignment.Center
        Tab.Instance = TabButton
        
        -- Tab Page Frame (The wrapper for all section containers)
        local PageFrame = CreateBaseFrame(PageContainer, Name .. "Page", 
            UDim2.new(1, 0, 1, 0), nil, THEME.Background)
        PageFrame.BackgroundTransparency = 1
        PageFrame.Visible = false
        Tab.PageFrame = PageFrame
        
        -- FIX: Section Container to hold the grid layout
        local SectionContainer = CreateBaseFrame(PageFrame, "SectionContainer",
            UDim2.new(1, 0, 1, 0), UDim2.fromScale(0, 0), THEME.Background)
        SectionContainer.BackgroundTransparency = 1
        
        -- FIX: UIGridLayout for Flow-Down Section System
        local SectionGridLayout = Instance.new("UIGridLayout")
        SectionGridLayout.CellPadding = UDim2.new(0, THEME.Padding, 0, THEME.Padding)
        SectionGridLayout.StartCorner = Enum.StartCorner.TopLeft
        SectionGridLayout.FillDirection = Enum.FillDirection.Horizontal
        SectionGridLayout.FillDirectionMaxCells = THEME.SectionColumnCount -- e.g., 2 sections per row
        SectionGridLayout.SortOrder = Enum.SortOrder.LayoutOrder
        
        -- Calculate Cell Size: (1 / ColumnCount) scale minus pixel padding
        -- (85% of 650 is 552.5. If we have 2 columns, each needs ~268px. )
        local CellScale = 1 / THEME.SectionColumnCount
        local CellWidth = UDim2.new(CellScale, -THEME.Padding, 0, 0) -- Subtract padding
        local CellHeight = UDim2.new(0, 200, 0, 0) -- Fixed section height (can grow later)
        
        SectionGridLayout.CellSize = UDim2.new(CellWidth.Scale, CellWidth.Offset, CellHeight.Scale, CellHeight.Offset)
        SectionGridLayout.Parent = SectionContainer
        Tab.SectionContainer = SectionContainer

        -- Selection Logic
        function Tab:Select()
            -- Hide all pages, reset all button colors
            for _, childTab in ipairs(Window.Children) do
                if type(childTab) == "table" and childTab.PageFrame and childTab.Instance then 
                    childTab.PageFrame.Visible = false
                    childTab.Instance.BackgroundColor3 = THEME.Header
                end
            end
            
            -- Show this page, highlight this button
            Tab.PageFrame.Visible = true
            Tab.Instance.BackgroundColor3 = THEME.Accent
        end
        
        TabButton.MouseButton1Click:Connect(function()
            Tab:Select()
        end)

        -- --- SECTION METHOD ---
        
        Tab.addSection = function(SectionName, Side)
            local Section = BaseComponent(Tab, {Text = SectionName, Side = Side})
            
            -- Section Frame now uses CellSize set by the UIGridLayout
            local SectionFrame = CreateBaseFrame(Tab.SectionContainer, SectionName .. "Section",
                UDim2.fromScale(1, 1), nil, THEME.Background)
            SectionFrame.BackgroundTransparency = 0
            Section.Instance = SectionFrame
            
            -- Inner padding frame for controls
            local ControlContainer = CreateBaseFrame(SectionFrame, "ControlContainer",
                UDim2.new(1, -THEME.SectionContentPadding * 2, 1, -THEME.SectionContentPadding * 2), 
                UDim2.new(0, THEME.SectionContentPadding, 0, THEME.SectionContentPadding),
                THEME.Background)
            ControlContainer.BackgroundTransparency = 1
            
            -- ListLayout for controls
            local ControlLayout = Instance.new("UIListLayout")
            ControlLayout.FillDirection = Enum.FillDirection.Vertical
            ControlLayout.SortOrder = Enum.SortOrder.LayoutOrder
            ControlLayout.Padding = UDim.new(0, THEME.Padding/2)
            ControlLayout.Parent = ControlContainer
            
            -- Section Title Label
            local TitleFrame = Instance.new("Frame")
            TitleFrame.Size = UDim2.new(1, 0, 0, 15)
            TitleFrame.BackgroundTransparency = 1
            TitleFrame.Parent = ControlContainer
            
            local SectionTitle = Instance.new("TextLabel")
            SectionTitle.Text = SectionName
            SectionTitle.Size = UDim2.new(1, 0, 1, 0)
            SectionTitle.TextColor3 = THEME.Accent
            SectionTitle.BackgroundTransparency = 1
            SectionTitle.Font = Enum.Font.SourceSansBold
            SectionTitle.TextSize = 14
            SectionTitle.Parent = TitleFrame
            
            Section.UIContainer = ControlContainer 

            -- Helper function to create a basic control component container
            local function CreateControlContainer(Type, Options)
                local Control = BaseComponent(Section, Options)
                
                local Container = CreateBaseFrame(ControlContainer, Type .. Options.Text:gsub("%s", ""),
                    UDim2.new(1, 0, 0, THEME.ControlHeight), nil, THEME.ControlBg)
                Container.Name = Type .. "_" .. Options.Text:gsub("%s", "")
                Container.BackgroundTransparency = 0
                Control.Instance = Container
                
                -- Control Label
                local TextLabel = Instance.new("TextLabel")
                TextLabel.Text = Options.Text or Type
                TextLabel.Size = UDim2.new(0.5, -5, 1, 0)
                TextLabel.Position = UDim2.new(0, THEME.Padding, 0, 0)
                TextLabel.TextColor3 = THEME.Text
                TextLabel.BackgroundTransparency = 1
                TextLabel.Font = Enum.Font.SourceSans
                TextLabel.TextSize = 13
                TextLabel.TextXAlignment = Enum.TextXAlignment.Left
                TextLabel.Parent = Container
                
                Control.Label = TextLabel
                
                return Control, Container
            end

            -- --- 4. CONTROL METHODS ---
            
            -- Checkbox
            function Section.addCheck(Options)
                local Control, Container = CreateControlContainer("Check", Options)
                
                local IsChecked = false
                
                local CheckBox = CreateButton(Container, IsChecked and "✓" or "",
                    UDim2.new(0, 20, 0, 18), UDim2.new(1, -25, 0.5, -9), THEME.Background, UDim.new(0, 3))
                CheckBox.TextSize = 16
                CheckBox.TextXAlignment = Enum.TextXAlignment.Center
                CheckBox.BorderColor3 = THEME.Accent
                CheckBox.BorderSizePixel = 1
                
                local function UpdateVisual()
                    if IsChecked then
                        CheckBox.BackgroundColor3 = THEME.Accent
                        CheckBox.Text = "✓"
                    else
                        CheckBox.BackgroundColor3 = THEME.Background
                        CheckBox.Text = ""
                    end
                end
                
                CheckBox.MouseButton1Click:Connect(function()
                    IsChecked = not IsChecked
                    UpdateVisual()
                    if Options.Callback then Options.Callback(IsChecked) end
                end)
                
                return Control
            end

            -- Slider
            function Section.addSlider(Options)
                local Control, Container = CreateControlContainer("Slider", Options)
                
                local Min = Options.Minimum or 0
                local Max = Options.Maximum or 100
                local Value = Options.Default or Min
                
                local SliderBar = CreateBaseFrame(Container, "SliderBar", 
                    UDim2.new(0.4, 0, 0, 4), UDim2.new(0.5, 0, 0.5, -2), THEME.Background)
                
                local Fill = CreateBaseFrame(SliderBar, "Fill", 
                    UDim2.new((Value - Min) / (Max - Min), 0, 1, 0), nil, THEME.Accent, UDim.new(0, 0))
                
                local Handle = CreateBaseFrame(SliderBar, "Handle",
                    UDim2.new(0, 10, 0, 10), UDim2.fromScale(0, 0.5), THEME.Accent)
                Handle.Position = UDim2.new((Value - Min) / (Max - Min), -5, 0.5, -5)
                Handle.ZIndex = 2
                Handle.Active = true
                
                local ValueLabel = Instance.new("TextLabel")
                ValueLabel.Size = UDim2.new(0.15, 0, 1, 0)
                ValueLabel.Position = UDim2.new(0.8, 0, 0, 0)
                ValueLabel.TextColor3 = THEME.Accent
                ValueLabel.BackgroundTransparency = 1
                ValueLabel.Font = Enum.Font.SourceSans
                ValueLabel.TextSize = 13
                ValueLabel.TextXAlignment = Enum.TextXAlignment.Right
                ValueLabel.Parent = Container

                local function UpdateValue(newValue)
                    Value = math.min(Max, math.max(Min, newValue))
                    local ratio = (Value - Min) / (Max - Min)
                    
                    Fill.Size = UDim2.new(ratio, 0, 1, 0)
                    Handle.Position = UDim2.new(ratio, -5, 0.5, -5)
                    ValueLabel.Text = string.format("%.0f%s", Value, Options.Postfix or "")
                    
                    if Options.Callback then Options.Callback(Value) end
                end

                local dragging = false
                Handle.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = true
                        Handle.ZIndex = 3
                    end
                end)

                Handle.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = false
                        Handle.ZIndex = 2
                    end
                end)

                Container.MouseMoved:Connect(function(x, y)
                    if dragging then
                        local xPos = math.min(math.max(x - SliderBar.AbsolutePosition.X, 0), SliderBar.AbsoluteSize.X)
                        local ratio = xPos / SliderBar.AbsoluteSize.X
                        local newValue = Min + ratio * (Max - Min)
                        UpdateValue(newValue)
                    end
                end)
                
                UpdateValue(Value) -- Initial call
                return Control
            end
            
            -- Dropdown
            function Section.addDropdown(Options)
                local Control, Container = CreateControlContainer("Dropdown", Options)
                
                local CurrentSelection = Options.List and Options.List[1] or "None"
                local ListOpen = false
                
                local DropdownButton = CreateButton(Container, CurrentSelection,
                    UDim2.new(0.4, 0, 1, 0), UDim2.new(0.5, 0, 0, 0), THEME.Background)
                
                -- Dropdown list parented to the ScreenGui (or a top-level container) for true overlay
                local ListFrame = CreateBaseFrame(ScreenGui, "DropdownList",
                    UDim2.new(0, 0, 0, 0), -- Size will be set dynamically
                    UDim2.fromScale(0, 0), THEME.ControlBg)
                ListFrame.BackgroundTransparency = 0
                ListFrame.Visible = false
                ListFrame.ZIndex = 5 -- High ZIndex
                
                local ListLayout = Instance.new("UIListLayout")
                ListLayout.FillDirection = Enum.FillDirection.Vertical
                ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
                ListLayout.Parent = ListFrame

                local function ToggleList()
                    ListOpen = not ListOpen
                    
                    Window.InputBlocker.Visible = ListOpen -- Activate/Deactivate input blocker

                    if ListOpen then
                        -- Calculate correct absolute position and size
                        local absPos = Container.AbsolutePosition
                        local absSize = Container.AbsoluteSize
                        
                        -- Set position: below the container
                        ListFrame.Position = UDim2.fromOffset(absPos.X + 1, absPos.Y + absSize.Y + 1)
                        
                        -- Set size: width matches the container's width
                        ListFrame.Size = UDim2.new(0, absSize.X * 0.4, 0, #Options.List * 20)
                        ListFrame.Visible = true
                    else
                        ListFrame.Visible = false
                    end
                end

                DropdownButton.MouseButton1Click:Connect(ToggleList)
                
                -- This allows clicking anywhere on the screen (the InputBlocker) to close the dropdown
                Window.InputBlocker.MouseButton1Click:Connect(function()
                    if ListOpen then ToggleList() end
                end)

                local function SelectOption(option)
                    CurrentSelection = option
                    DropdownButton.Text = option
                    ToggleList()
                    if Options.Callback then Options.Callback(option) end
                end

                for i, option in ipairs(Options.List) do
                    local optionButton = CreateButton(ListFrame, option, 
                        UDim2.new(1, 0, 0, 20), nil, THEME.ControlBg)
                    optionButton.MouseEnter:Connect(function() optionButton.BackgroundColor3 = THEME.ControlHover end)
                    optionButton.MouseLeave:Connect(function() optionButton.BackgroundColor3 = THEME.ControlBg end)
                    optionButton.TextXAlignment = Enum.TextXAlignment.Left
                    optionButton.ZIndex = 5
                    
                    optionButton.MouseButton1Click:Connect(function()
                        SelectOption(option)
                    end)
                end
                
                return Control
            end
            
            -- Text Input
            function Section.addInput(Options)
                local Control, Container = CreateControlContainer("Input", Options)
                
                local TextBox = Instance.new("TextBox")
                TextBox.Name = "InputBox"
                TextBox.Size = UDim2.new(0.4, 0, 1, 0)
                TextBox.Position = UDim2.new(0.5, 0, 0, 0)
                TextBox.Text = Options.Default or ""
                TextBox.PlaceholderText = Options.Placeholder or ""
                TextBox.TextColor3 = THEME.Text
                TextBox.BackgroundColor3 = THEME.Background
                TextBox.Font = Enum.Font.SourceSans
                TextBox.TextSize = 13
                TextBox.BorderSizePixel = 0
                TextBox.Parent = Container
                
                local corner = Instance.new("UICorner")
                corner.CornerRadius = THEME.CornerRadius
                corner.Parent = TextBox

                TextBox.FocusLost:Connect(function(enterPressed)
                    if enterPressed or Options.ContinuousUpdate then
                        if Options.Callback then Options.Callback(TextBox.Text) end
                    end
                end)
                
                return Control
            end

            -- Color Picker (Simple HSV/Color3 representation)
            function Section.addColorPicker(Options)
                local Control, Container = CreateControlContainer("ColorPicker", Options)
                
                local CurrentColor = Options.Default or Color3.new(1, 0, 0)
                
                local ColorBox = CreateButton(Container, "", 
                    UDim2.new(0, 20, 0, 20), UDim2.new(1, -25, 0.5, -10), CurrentColor, UDim.new(0, 3))
                
                ColorBox.MouseButton1Click:Connect(function()
                    Library:Toast("Color picker logic is complex and must be manually implemented.", 5)
                    if Options.Callback then Options.Callback(CurrentColor) end -- Placeholder callback
                end)
                
                return Control
            end

            -- Button
            function Section.addButton(Options)
                local Control, Container = CreateControlContainer("Button", Options)
                Container.BackgroundTransparency = 1
                
                local Button = CreateButton(Container, Options.Text,
                    UDim2.new(1, 0, 1, 0), nil, THEME.Accent)
                
                Button.MouseButton1Click:Connect(function()
                    if Options.Callback then Options.Callback() end
                    Library:Toast(Options.Text .. " executed.", 2)
                end)

                return Control
            end

            -- Label
            function Section.addLabel(Options)
                local Control, Container = CreateControlContainer("Label", Options)
                Container.BackgroundTransparency = 1
                
                local Label = Instance.new("TextLabel")
                Label.Text = Options.Text
                Label.Size = UDim2.new(1, 0, 1, 0)
                Label.Position = UDim2.new(0, 0, 0, 0)
                Label.TextColor3 = Options.Color or THEME.Text
                Label.BackgroundTransparency = 1
                Label.Font = Enum.Font.SourceSans
                Label.TextSize = 13
                Label.Parent = Container

                Control.Label.TextXAlignment = Enum.TextXAlignment.Center
                Control.Label.Size = UDim2.new(1, 0, 1, 0)
                Control.Label.Position = UDim2.fromScale(0, 0)

                return Control
            end
            
            return Tab:AddChild(Section)
        end
        
        Window:AddChild(Tab)
        
        -- Select the first tab automatically
        if #Window.Children == 1 then
            Tab:Select()
        end
        
        return Tab
    end

    -- --- 3. TOAST NOTIFICATION SYSTEM ---

    local ToastQueue = {} 
    local ToastTweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local ToastVisible = false

    function Library:Toast(Message, Duration)
        table.insert(ToastQueue, {Message = Message, Duration = Duration or 3}) 
        
        if ToastVisible then return end
        
        local function ShowNextToast()
            if #ToastQueue == 0 then
                ToastVisible = false
                return
            end
            
            ToastVisible = true
            local ToastData = table.remove(ToastQueue, 1)
            
            local ToastFrame = CreateBaseFrame(
                PlayerGui, "Toast", 
                UDim2.new(0, 300, 0, 50), 
                UDim2.new(0.5, -150, 1, 60), -- Starts below screen
                THEME.ToastBg, UDim.new(0, 8)
            )
            ToastFrame.ClipsDescendants = true
            ToastFrame.BackgroundTransparency = 0.2
            ToastFrame.BorderSizePixel = 1
            ToastFrame.BorderColor3 = THEME.Accent
            ToastFrame.ZIndex = 6 -- Higher than everything else

            
            local ToastLabel = Instance.new("TextLabel")
            ToastLabel.Text = ToastData.Message
            ToastLabel.Size = UDim2.new(1, -20, 1, -20)
            ToastLabel.Position = UDim2.new(0, 10, 0, 10)
            ToastLabel.TextColor3 = THEME.Text
            ToastLabel.BackgroundTransparency = 1
            ToastLabel.TextSize = 14
            ToastLabel.Font = Enum.Font.SourceSans
            ToastLabel.Parent = ToastFrame
            
            local StartPos = UDim2.new(0.5, -150, 1, 60)
            local EndPos = UDim2.new(0.5, -150, 1, -60) 
            
            local TweenIn = TweenService:Create(ToastFrame, ToastTweenInfo, {Position = EndPos})
            TweenIn:Play()
            TweenIn.Completed:Wait()
            
            task.wait(ToastData.Duration)
            
            local TweenOut = TweenService:Create(ToastFrame, ToastTweenInfo, {Position = StartPos, BackgroundTransparency = 1})
            TweenOut:Play()
            TweenOut.Completed:Wait()
            
            ToastFrame:Destroy()
            ShowNextToast()
        end
        
        if not ToastVisible then
            ShowNextToast()
        end
    end
    -- End of Toast System

    return Window
end

return Library
